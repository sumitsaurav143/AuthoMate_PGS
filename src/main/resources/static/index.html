<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AuthoMate</title>

    <!-- =========================
         GLOBAL TAB STYLES
         ========================= -->
    <style>
        body {
            margin: 0;
            font-family: "Inter", "Segoe UI", Roboto, Arial, sans-serif;
            background: #020617;
        }

        .tab-bar {
            display: flex;
            background: #020617;
            border-bottom: 1px solid #334155;
        }

        .tab {
            padding: 14px 24px;
            cursor: pointer;
            font-weight: 800;
            color: #94a3b8;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .tab.active {
            color: #e0e7ff;
            border-bottom: 3px solid #6366f1;
            background: linear-gradient(180deg, #020617, #020024);
        }

        .tab-content {
            display: none;
            height: calc(100vh - 52px);
            overflow: hidden;
        }

        .tab-content.active {
            display: block;
        }

                /* RESET */
        * {
            box-sizing: border-box;
        }

        /* CONTAINER */
        .container {
            height: 100%;
            background: #020617;
            box-shadow: 0 30px 80px rgba(0,0,0,0.7);
            padding: 22px 26px;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 14px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        .header h2 {
            margin: 0;
            font-size: 22px;
            font-weight: 800;
            letter-spacing: 0.3px;
            color: #e5e7eb;
        }

        /* STATUS */
        .status {
            padding: 6px 18px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 800;
        }

        .status.idle { background: #1e293b; color: #94a3b8; }
        .status.running { background: #16a34a; color: #022c22; }
        .status.stopped { background: #facc15; color: #713f12; }
        .status.error { background: #dc2626; color: #450a0a; }

        /* STEPS GRID */
        .steps {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin: 20px 0;
        }

        .stepsFarmer {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 20px 0;
        }

        /* STEP CARD */
        .step {
            background: linear-gradient(100deg, #020617, #020617cc);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 18px;
            box-shadow:
                inset 0 0 0 1px rgba(255,255,255,0.04),
                0 12px 24px rgba(0,0,0,0.6);
            transition: transform 0.2s ease;
        }

        .step:hover {
            transform: translateY(-2px);
        }

        .step h4 {
            margin: 0 0 12px;
            font-size: 14px;
            font-weight: 700;
            color: #c7d2fe;
        }

        /* DATA ROW */
        .data-row {
            display: flex;
            gap: 12px;
            width: 100%;
            flex-wrap: wrap;
        }

        /* INPUT & SELECT */
        .step input,
        .step select {
            width: 100%;
            padding: 11px 14px;
            margin-top: 8px;
            height: 42px;
            border-radius: 12px;
            border: 1px solid #334155;
            font-size: 14px;
            background: #020617;
            color: #e5e7eb;
        }

        .step input::placeholder {
            color: #64748b;
        }

        .step input:focus,
        .step select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99,102,241,0.35);
        }

        /* REMOVE NATIVE SELECT STYLES */
        .step select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
        }

        /* BUTTON BASE */
        .step button {
            width: 100%;
            padding: 12px;
            margin-top: 14px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 800;
            border: none;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .step button:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(0,0,0,0.5);
        }

        /* BUTTON TYPES */
        .validate-btn {
            background: linear-gradient(135deg, #475569, #64748b);
            color: #e5e7eb;
        }

        .run-btn {
            background: linear-gradient(135deg, #14b8a6, #22d3ee);
            color: #022c22;
        }

        .stop-btn {
            background: linear-gradient(135deg, #ef4444, #fb7185);
            color: #450a0a;
        }

        /* STOP BUTTON GROUP */
        .stopbtns {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* POWER BUTTON */
        .shutoff {
            width: 44px;
            border-radius: 50%;
            background: radial-gradient(circle, #fb7185, #b91c1c);
            color: white;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 0 16px rgba(239,68,68,0.8);
        }

        .shutoff:hover {
            transform: scale(1.15);
        }

        /* DISABLED */
        button:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

                /* LOGS */
        .logs {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
        }

        .logs h3 {
            margin: 6px 0;
            font-size: 16px;
            font-weight: 800;
            color: #e5e7eb;
        }

        /* LOG TERMINAL */
        .log-box {
            background: #020617;
            color: #22c55e;
            height: 50vh;
            overflow-y: auto;
            padding: 12px;
            border-radius: 14px;
            font-size: 14px;
            font-family: "JetBrains Mono", monospace;
            white-space: pre-wrap;
            box-shadow: inset 0 0 12px rgba(0,0,0,0.9);
        }

        /* FOOTER */
        .footer-copy {
            font-size: 12px;
            color: #94a3b8;
            text-align: center;
            margin-top: 12px;
            font-weight: 600;
        }

        /* STEP 3 ROW LAYOUTS */
        .data-row {
            display: grid;
            gap: 12px;
            margin-top: 8px;
        }

        /* Year | Season | Month */
        .data-row.three-cols {
            grid-template-columns: repeat(3, 1fr);
        }

        /* From Date | To Date */
        .data-row.two-cols {
            grid-template-columns: repeat(2, 1fr);
        }

        /* BODY */
        body {
            background: linear-gradient(135deg, #020024, #090979, #020617);
        }

        /* CONTAINER */
        .container {
            background: linear-gradient(180deg, #020617, #020024);
            box-shadow: 0 30px 90px rgba(2, 6, 23, 0.85);
        }

        /* HEADER */
        .header {
            border-bottom: 1px solid rgba(148,163,184,0.15);
        }

        .header h2 {
            color: #e0e7ff;
        }

        /* STATUS */
        .status.idle {
            background: linear-gradient(135deg, #334155, #1e293b);
            color: #cbd5f5;
        }

        .status.running {
            background: linear-gradient(135deg, #22c55e, #4ade80);
            color: #052e16;
        }

        .status.stopped {
            background: linear-gradient(135deg, #fbbf24, #fde047);
            color: #713f12;
        }

        .status.error {
            background: linear-gradient(135deg, #ef4444, #fb7185);
            color: #450a0a;
        }

        /* STEP CARD */
        .step {
            background: linear-gradient(145deg, #020617, #020024);
            border: 1px solid rgba(148,163,184,0.12);
            box-shadow:
                inset 0 0 0 1px rgba(148,163,184,0.04),
                0 14px 28px rgba(2,6,23,0.8);
        }

        .step h4 {
            color: #a5b4fc;
        }

        /* INPUT & SELECT */
        .step input,
        .step select {
            background: linear-gradient(180deg, #020617, #020024);
            border: 1px solid #334155;
            color: #e5e7eb;
        }

        .step input::placeholder {
            color: #94a3b8;
        }

        .step input:focus,
        .step select:focus {
            border-color: #818cf8;
            box-shadow: 0 0 0 3px rgba(129,140,248,0.35);
        }

        /* BUTTONS */
        .validate-btn {
            background: linear-gradient(135deg, #64748b, #475569);
            color: #f8fafc;
        }

        .run-btn {
            background: linear-gradient(135deg, #06b6d4, #22d3ee);
            color: #022c22;
        }

        .stop-btn {
            background: linear-gradient(135deg, #f43f5e, #fb7185);
            color: #450a0a;
        }

        /* POWER BUTTON */
        .shutoff {
            background: radial-gradient(circle, #fb7185, #be123c);
            box-shadow: 0 0 18px rgba(251,113,133,0.8);
        }

        /* LOGS */
        .logs h3 {
            color: #e0e7ff;
        }

        /* LOG TERMINAL */
        .log-box {
            background: radial-gradient(circle at top, #020617, #020024);
            color: #4ade80;
            box-shadow: inset 0 0 14px rgba(2,6,23,0.9);
        }

        .logs {
            flex: 1;           /* takes remaining space */
            display: flex;
            flex-direction: column;
        }

        /* FOOTER */
        .footer-copy {
            color: #a5b4fc;
        }
    </style>
</head>

<body>

<!-- =========================
     TAB HEADER
     ========================= -->
<div class="tab-bar">
    <div class="tab active" onclick="openTab('farmersTab', this)">Farmers Entry</div>
    <div class="tab" onclick="openTab('peersTab', this)">Peers Appraisal</div>
</div>

<!-- =========================
     FARMERS ENTRY TAB
     ========================= -->
<div id="farmersTab" class="tab-content active">
    <!-- ===== PAGE 1 BODY (UNCHANGED) ===== -->
    <div class="container">

        <!-- Header -->
        <div class="header">
            <h2>Farmers Entry</h2>
            <div class="status" id="status">Idle</div>
        </div>

        <!-- Steps -->
        <div class="stepsFarmer">

            <!-- Step 1 -->
            <div class="step">
                <h4>Step 1: Upload Excel</h4>
                <input type="file" id="excelFile" accept=".xls,.xlsx">
                <button class="validate-btn" onclick="validateExcel()">Validate Excel</button>
            </div>

            <!-- Step 2 -->
            <div class="step">
                <h4>Step 2: Credentials</h4>
                <input type="text" id="userId" placeholder="User ID" value="Gnr1">
                <input type="password" id="password" placeholder="Password" value="Vvkignr@1">
            </div>

            <!-- Step 3 -->
            <div class="step">
                <h4>Step 3: Automation</h4>
                <button class="run-btn" id="runBtn" onclick="startAutomation()" disabled>
                    ‚ñ∂ Run Automation
                </button>
                <div class="stopbtns">
                    <button class="stop-btn" id="stopBtn" onclick="stopAutomation()" disabled>
                        ‚õî Stop Automation
                    </button>
                    <button class="shutoff" onclick="stopApp()"> ‚èª </button>
                </div>
            </div>

        </div>

        <!-- Logs -->
        <div class="logs">
            <h3>Automation Logs</h3>
            <div class="log-box" id="logBox">Waiting for logs...</div>
        </div>

        <p class="footer-copy">¬©Ô∏è Sumit Sinha - AuthoMate <span class="version">v0.0.3</span></p>

    </div>
</div>

<!-- =========================
     PEERS APPRAISAL TAB
     ========================= -->
<div id="peersTab" class="tab-content">
    <!-- ===== PAGE 2 BODY (UNCHANGED) ===== -->
    <div class="container">

        <!-- Header -->
        <div class="header">
            <h2>Peers Appraisal</h2>
            <div class="status" id="status2">Idle</div>
        </div>

        <!-- Steps -->
        <div class="steps">

            <!-- Step 1 -->
            <div class="step">
                <h4>Step 1: Upload Excel</h4>
                <input type="file" id="excelFile2" accept=".xls,.xlsx">
                <button class="validate-btn" onclick="validateExcel2()">Validate Excel</button>
            </div>

            <!-- Step 2 -->
            <div class="step">
                <h4>Step 2: User Credentials</h4>
                <input type="text" id="userId2" placeholder="User ID" value="CG00794">
                <input type="password" id="password2" placeholder="Password" value="Bilaspur@1">
            </div>

            <!-- Step 3 -->
            <div class="step">
                <h4>Step 3: Peers Appraisal Details</h4>

                <!-- Row 1 -->
                <div class="data-row three-cols">
                    <select id="year">
                        <option value="">Year</option>
                        <option>2025</option>
                        <option>2026</option>
                        <option>2027</option>
                        <option>2028</option>
                        <option>2029</option>
                        <option>2030</option>
                    </select>

                    <select id="season">
                        <option value="">Season</option>
                        <option>Summer</option>
                        <option>Rabi</option>
                        <option>Kharif</option>
                    </select>

                    <select id="month">
                        <option value="">Month</option>
                        <option>January</option>
                        <option>February</option>
                        <option>March</option>
                        <option>April</option>
                        <option>May</option>
                        <option>June</option>
                        <option>July</option>
                        <option>August</option>
                        <option>September</option>
                        <option>October</option>
                        <option>November</option>
                        <option>December</option>
                    </select>
                </div>

                <!-- Row 2 -->
                <div class="data-row two-cols">
                    <input type="date" id="fromDate" placeholder="From Date">
                    <input type="date" id="toDate" placeholder="To Date">
                </div>
            </div>


            <!-- Step 4 -->
            <div class="step">
                <h4>Step 4: Automation</h4>
                <button class="run-btn" id="runBtn2" onclick="startAutomation2()" disabled>
                    ‚ñ∂ Run Automation
                </button>
                <div class="stopbtns">
                    <button class="stop-btn" id="stopBtn2" onclick="stopAutomation2()" disabled>
                        ‚õî Stop Automation
                    </button>
                    <button class="shutoff" onclick="stopApp()"> ‚èª </button>
                </div>
            </div>

        </div>

        <!-- Logs -->
        <div class="logs">
            <h3>Automation Logs</h3>
            <div class="log-box" id="logBox2">Waiting for logs...</div>
        </div>

        <p class="footer-copy">¬©Ô∏è Sumit Sinha - AuthoMate <span class="version">v0.0.3</span></p>

    </div>
</div>

<!-- =========================
     TAB SWITCH SCRIPT
     ========================= -->
<script>
    function openTab(tabId, el) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        el.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    let logInterval = null;
    let currentRunId = null;

    const eventSource = new EventSource("/status/stream");

    eventSource.onmessage = function (event) {
        const state = event.data;

        if (state === "STOPPED"){
            stopAutomation();
        }
        if (state === "FAILED"){
            stopAutomation();
            setStatus("Error", "error");
            setStatus2("Error", "error");
        }
    };

    setStatus("Idle", "idle");
    setStatus2("Idle", "idle");

    function stopApp() {
        fetch('/app/shutdown', {
            method: 'POST'
        }).then(() => {
            window.open('', '_self');
            window.close(); // close browser tab
        });
    }

    function validateExcel() {
        setStatus("Running", "running");
        const fileInput = document.getElementById("excelFile");
        const status = document.getElementById("status");

        if (!fileInput.files.length) {
            setStatus("Error", "error");
            status.textContent = "‚ö†Ô∏è Upload Excel first";
            return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        status.textContent = "üîç Validating Excel...";

        fetch("/validate", { method: "POST", body: formData })
            .then(res => res.json())
            .then(report => {

              const logBox = document.getElementById("logBox");

            if (report.valid) {
                 excelValidated = true;
                 document.getElementById("runBtn").disabled = false;
                 status.textContent = "‚úÖ Excel valid. Ready to run.";
                logBox.innerHTML =
                    "<div style='color:#22c55e; font-weight:600;'>‚úÖ Excel validated successfully, you are good to go...</div>";
            } else {
                setStatus("Error", "error");

                excelValidated = false;
                 document.getElementById("runBtn").disabled = true;
                 status.textContent = "‚ùå Invalid Excel File. Re-Upload";

                let errorHtml = "<div style='color:#ef4444; font-weight:600;'>‚ùå Excel Validation failed</div><ul>";

                if (report.fileErrors && report.fileErrors.length > 0) {
                    report.fileErrors.forEach(err => {
                        errorHtml += `<li style="color:#ef4444;">${err}</li>`;
                    });
                } else {
                    errorHtml += "<li style='color:#ef4444;'>Invalid file format. Please upload a valid .xlsx file.</li>";
                }

                errorHtml += "</ul>";

                logBox.innerHTML = errorHtml;
            }

            });
    }



    function startAutomation() {
        setStatus("Running", "running");
        const runBtn = document.getElementById("runBtn");
        const stopBtn = document.getElementById("stopBtn");
        const status = document.getElementById("status");

        const userId = document.getElementById("userId").value;
        const password = document.getElementById("password").value;
        const fileInput = document.getElementById("excelFile");

        if (!userId || !password) {
            setStatus("Error", "error");
            status.textContent = "‚ö†Ô∏è Please enter User ID and Password";
            return;
        }

        if (!fileInput.files.length) {
            setStatus("Error", "error");
            status.textContent = "‚ö†Ô∏è Please upload Excel file";
            return;
        }

        const formData = new FormData();
        formData.append("userId", userId);
        formData.append("password", password);
        formData.append("file", fileInput.files[0]);

        runBtn.disabled = true;
        stopBtn.disabled = false;
        status.textContent = "üì§ Uploading file & starting automation...";

        fetch("/start", {
            method: "POST",
            body: formData   // ‚ùó NO content-type header
        })
        .then(res => res.json())
        .then(data => {
            currentRunId = data.runId;
            status.textContent = "üöÄ Automation running...";

            if (logInterval) clearInterval(logInterval);
            logInterval = setInterval(() => loadLogs(currentRunId), 2000);
        })
        .catch(err => {
            console.error(err);
            setStatus("Error", "error");
            status.textContent = "‚ùå Failed to start automation";
            runBtn.disabled = false;
            stopBtn.disabled = true;
        });
    }



    function validateExcel2() {
        setStatus2("Running", "running");
        const fileInput = document.getElementById("excelFile2");
        const status = document.getElementById("status2");

        if (!fileInput.files.length) {
            setStatus2("Error", "error");
            status.textContent = "‚ö†Ô∏è Upload Excel first";
            return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        status.textContent = "üîç Validating Excel...";

        fetch("/validate2", { method: "POST", body: formData })
            .then(res => res.json())
            .then(report => {

              const logBox = document.getElementById("logBox2");

            if (report.valid) {
                 excelValidated = true;
                 document.getElementById("runBtn2").disabled = false;
                 status.textContent = "‚úÖ Excel valid. Ready to run.";
                logBox.innerHTML =
                    "<div style='color:#22c55e; font-weight:600;'>‚úÖ Excel validated successfully, you are good to go...</div>";
            } else {
                setStatus2("Error", "error");

                excelValidated = false;
                 document.getElementById("runBtn2").disabled = true;
                 status.textContent = "‚ùå Invalid Excel File. Re-Upload";

                let errorHtml = "<div style='color:#ef4444; font-weight:600;'>‚ùå Excel Validation failed</div><ul>";

                if (report.fileErrors && report.fileErrors.length > 0) {
                    report.fileErrors.forEach(err => {
                        errorHtml += `<li style="color:#ef4444;">${err}</li>`;
                    });
                } else {
                    errorHtml += "<li style='color:#ef4444;'>Invalid file format. Please upload a valid .xlsx file.</li>";
                }

                errorHtml += "</ul>";

                logBox.innerHTML = errorHtml;
            }

            });
    }

    function startAutomation2() {
        setStatus2("Running", "running");
        const runBtn = document.getElementById("runBtn2");
        const stopBtn = document.getElementById("stopBtn2");
        const status = document.getElementById("status2");

        const userId = document.getElementById("userId2").value;
        const password = document.getElementById("password2").value;
        const year = document.getElementById("year").value;
        const month = document.getElementById("month").value;
        const season = document.getElementById("season").value;
        const fromDate = document.getElementById("fromDate").value;
        const toDate = document.getElementById("toDate").value;
        const fileInput = document.getElementById("excelFile2");

        if (!userId || !password || !year || !month || !season || !fromDate || !toDate) {
            setStatus2("Error", "error");
            status.textContent = "‚ö†Ô∏è Please enter complete peers details";
            return;
        }

        if (!fileInput.files.length) {
            setStatus2("Error", "error");
            status.textContent = "‚ö†Ô∏è Please upload Excel file";
            return;
        }

        const formData = new FormData();
        formData.append("userId", userId);
        formData.append("password", password);
        formData.append("year", year);
        formData.append("month", month);
        formData.append("season", season);
        formData.append("fromDate", fromDate);
        formData.append("toDate", toDate);
        formData.append("file", fileInput.files[0]);

        runBtn.disabled = true;
        stopBtn.disabled = false;
        status.textContent = "üì§ Uploading file & starting automation...";

        fetch("/start2", {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            currentRunId = data.runId;
            status.textContent = "üöÄ Automation running...";

            if (logInterval) clearInterval(logInterval);
            logInterval = setInterval(() => loadLogs2(currentRunId), 2000);
        })
        .catch(err => {
            console.error(err);
            setStatus2("Error", "error");
            status.textContent = "‚ùå Failed to start automation";
            runBtn.disabled = false;
            stopBtn.disabled = true;
        });
    }

    function setStatus(text, state) {
        const status = document.getElementById("status");
        status.textContent = text;
        status.className = "status " + state;
    }

    function setStatus2(text, state) {
        const status = document.getElementById("status2");
        status.textContent = text;
        status.className = "status " + state;
    }

    function stopAutomation() {
        setStatus("Stopped", "stopped");
        const runBtn = document.getElementById("runBtn");
        const stopBtn = document.getElementById("stopBtn");
        const status = document.getElementById("status");

        stopBtn.disabled = true;
        runBtn.disabled = false;
        status.textContent = "Stopping automation...";

        fetch('/stop', { method: 'POST' })
            .then(() => {
                status.textContent = "Automation stopped";
            });
    }

    function stopAutomation2() {
        setStatus2("Stopped", "stopped");
        const runBtn = document.getElementById("runBtn2");
        const stopBtn = document.getElementById("stopBtn2");
        const status = document.getElementById("status2");

        stopBtn.disabled = true;
        runBtn.disabled = false;
        status.textContent = "Stopping automation...";

        fetch('/stop', { method: 'POST' })
            .then(() => {
                status.textContent = "Automation stopped";
            });
    }

    function loadLogs() {
        fetch('/logs')
            .then(res => res.text())
            .then(data => {
                const logBox = document.getElementById("logBox")
                logBox.textContent = data.replace(/","/g, '\n');
                logBox.scrollTop = logBox.scrollHeight;
            })
            .catch(() => {
                clearInterval(logInterval);
            });
    }

    function loadLogs2() {
        fetch('/logs')
            .then(res => res.text())
            .then(data => {
                const logBox = document.getElementById("logBox2")
                logBox.textContent = data.replace(/","/g, '\n');
                logBox.scrollTop = logBox.scrollHeight;
            })
            .catch(() => {
                clearInterval(logInterval);
            });
    }
</script>

</body>
</html>